<? include "../include/mypage_header.html"; ?>
<? include "../include/login_check.php"; ?>
<script type="text/javascript">
	$(document).ready(function(){
		$("#SearchYear").change(function(){
			$("#changeList").load(location.href+" #changeList",{SearchYear: $('#SearchYear').val(), memberCompany: $('#memberCompany').val()});
		});
		
		$("#memberCompany").change(function(){
			$("#changeList").load(location.href+" #changeList",{SearchYear: $('#SearchYear').val(), memberCompany: $('#memberCompany').val()});
		});
	});
</script>
        <div class="mypage_content">
            <div class="sb_box">
                <h1>교육담당자</h1>
                <div class="navi">
                    <i class="ph-light ph-house-line"></i>&nbsp;<i class="ph ph-caret-right"></i>&nbsp;나의학습실<i class="ph ph-caret-right"></i>&nbsp;교육담당자
                </div>
            </div>
            <div class="content">
                <h2>자사수강생 리스트</h2>
                <ul class="studentlst">
                    <select name="SearchYear" id="SearchYear" style="width: 150px;margin-bottom: -28px;">
						<option value="">년도 검색</option>
						<?
						for($i=2018;$i<=date("Y");$i++) { 
						?>
							<option value="<?=$i?>"><?=$i?>년</option>
						<?
						}
						?>
					</select>
					<select name="memberCompany" id="memberCompany" style="width: 150px;margin-bottom: -28px;">
						<option value="">사업장 검색</option>
                        <?
						$SQL = "SELECT a.ID , a.CompanyCode , b.CompanyName 
                                FROM MemberCompany a
                                LEFT JOIN Company b ON a.CompanyCode = b.CompanyCode 
                                WHERE a.ID = '$LoginMemberID' AND a.Del = 'N'";
                        $QUERY = mysqli_query($connect, $SQL);
						if($QUERY && mysqli_num_rows($QUERY)){
							while($ROW = mysqli_fetch_array($QUERY)){
                                extract($ROW);
						?>
                        <option value="<?=$CompanyCode?>"><?=$CompanyName?></option>
						<?
                            }
                        }
						?>
					</select>
					
                    <!-- List -->
                    <li id="changeList">
                        <?
						$i = 1;
						
						if($memberCompany){
                            $StrMemberCompany = "a.CompanyCode=$memberCompany";
                        }else{
                            $StrMemberCompany = "a.CompanyCode=(SELECT CompanyCode FROM Member WHERE ID='$LoginMemberID')";
                        }
                        
						if($SearchYear){
							$where = " WHERE $StrMemberCompany AND a.ServiceType IN ('A') AND YEAR(a.LectureStart)= '$SearchYear' ";
						}else{			    
							$where = " WHERE $StrMemberCompany AND a.ServiceType IN ('A') ";
						}

						$SQL = "SELECT DISTINCT a.LectureStart, a.LectureEnd, a.LectureCode
								FROM Study AS a 
								LEFT OUTER JOIN Company AS b ON a.CompanyCode=b.CompanyCode 
								$where
								ORDER BY a.LectureStart ASC, a.LectureEnd ASC; ";
                        // echo $SQL;
						$QUERY = mysqli_query($connect, $SQL);
						if($QUERY && mysqli_num_rows($QUERY)){
							while($ROW = mysqli_fetch_array($QUERY))
							{
								extract($ROW);
								?>
								<ul class="classdate">
									<li class="left"><?=$LectureStart?> ~ <?=$LectureEnd?> 개강</li>
									<li class="right"><a href="/public/mypage/manager_trainee_excel.php?LectureStart=<?=$LectureStart?>&LectureEnd=<?=$LectureEnd?>&LectureCode='<?=$LectureCode?>'" target="_blank">개강전체 엑셀출력</a></li>
								</ul>
                                <table width="100%" class="tbl_typeD mt15" border="0" cellspacing="0" summary="">
                                    <thead>
                                        <tr>
                                            <th>NO</th>
                                            <th>이름</th>
                                            <th>아이디</th>
                                            <th>과정명</th>
                                            <th>역량진단보기</th>
                                            <th>총학습시간</th>
                                            <th>수료여부</th>
                                            <th>상세보기</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <?
                                    if($memberCompany){
	                                    $StrMemberCompany2 = "b.CompanyCode=$memberCompany";
	                                }else{
	                                    $StrMemberCompany2 = "b.CompanyCode=(SELECT CompanyCode FROM Member WHERE ID='$LoginMemberID')";
	                                }
	                                
                                    $SQL2 = "SELECT a.CompanyCode, c.ServiceType, c.Category1, c.Category2, c.ContentsName, c.LectureCode, d.ID, d.Name, a.Seq, a.PassOK ,
                                                    (SELECT CategoryName FROM CourseCategory WHERE idx=c.Category1) AS Category1Name, 
                                                    (SELECT COUNT(*) FROM Study WHERE LectureStart=a.LectureStart AND LectureEnd=a.LectureEnd AND CompanyCode=a.CompanyCode AND LectureCode=a.LectureCode AND PassOk='Y') AS StudyCount, 
                                                    (SELECT COUNT(*) FROM Study WHERE LectureStart=a.LectureStart AND LectureEnd=a.LectureEnd AND CompanyCode=a.CompanyCode AND LectureCode=a.LectureCode AND PassOk='N') AS StudyBeCount,
                                                    (SELECT SUM(p.StudyTime) FROM Progress p WHERE p.ID = a.ID AND p.RegDate > '$LectureStart' AND p.RegDate < '$LectureEnd') AS TotalStudyTime
                                            FROM Study AS a 
                                            LEFT OUTER JOIN Company AS b ON a.CompanyCode=b.CompanyCode 
                                            LEFT OUTER JOIN Course AS c ON a.LectureCode=c.LectureCode 
                                            LEFT OUTER JOIN `Member` AS d ON a.ID = d.ID
                                            WHERE $StrMemberCompany2 AND a.ServiceType IN ('A') AND a.LectureStart='$LectureStart' AND a.LectureEnd='$LectureEnd' 
                                            ORDER BY c.ContentsName ASC";
                                    //if($LoginMemberID == "test05") echo $SQL2;
                                    $QUERY2 = mysqli_query($connect, $SQL2);

                                    if($QUERY2 && mysqli_num_rows($QUERY2)){
                                        while ($ROW = mysqli_fetch_array($QUERY2)) {
                                            extract($ROW);
                                            
                                            //전체수강시간
											if($TotalStudyTime > 86400){
											    $sec = $TotalStudyTime;
											    $h = floor($sec / 3600);
											    $m = floor(($sec % 3600) / 60);
											    $s = $sec % 60;
											    
											    $TotalStudyTime = sprintf("%02d시간 %02d분 %02d초", $h, $m, $s);
											}else{
											    $TotalStudyTime = gmdate("H시간 i분 s초", $TotalStudyTime);
											}
                                    ?>
                                            <tr>
                                                <td><?=$k+1;?></td>
                                                <td><?=$Name;?></td>
                                                <td><?=$ID;?></td>
                                                <td><?=$ContentsName;?></td>
                                                <td><a href="Javascript:TestResult('<?=$ID;?>')"><div class="mb5"><i class="ph ph-chart-donut" style="color:#78b1cf;; font-size: 30px;"></i></div>역량진단 보기</a></td>
                                                <td><?=$TotalStudyTime?></td>
                                                <td><?if($PassOK == "Y") echo "수료"; else echo "미수료";?></td>
                                                <td><a href="Javascript:ManagerCourseCheck('<?=$LectureStart?>','<?=$LectureEnd?>','<?=$LectureCode?>','<?=$ID;?>', '<?=$Seq;?>');"><div class="mb5"><img src="img/icon_bullets.svg" width="35"></div>상세보기</td>
                                            </tr>
                                    <?
                                            $k++;
                                        }
                                    }
                                    $i++;
                            ?>
                                    </tbody>
                    			</table>
                            <?
                                }
                            }else{
                            ?>
                                <br><br>
                                <ul>수강 내역이 없습니다.</ul>
                            <? } ?>
                    </li>
                    <!-- List // -->
                </ul>
            </div>
            <!--content-->
        </div>
        <!--mypage_content-->
    </div>
    <!--wrap-->
</body>
<? include "../../archive/include/footer.html"; ?>
<script>
    $(document).ready(function(){
        $('.mypage_menu .manager').addClass("on");
        $('.mypage_menu .manager ul').css('display','block');
        $('.mypage_menu .manager ul .trainee').addClass("on");
        $('.mypage_menu .manager a').find('i').toggleClass("ph-caret-up ph-caret-down");
    });
</script>